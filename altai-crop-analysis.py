import pandas as pd
import numpy as np
import os

# --- 1. –ü–ê–†–ê–ú–ï–¢–†–´ –§–ê–ô–õ–û–í ---
FILE_DATA = "–ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π –∫–ª–∏–º–∞—Ç –∏ NDVI.xls"                                   # –§–∞–π–ª —Å NDVI –∏ –º–µ—Ç–µ–æ–¥–∞–Ω–Ω—ã–º–∏
FILE_YIELD = "–î–∞–Ω–Ω—ã–µ —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º –∏ –æ–∫—Ä—É–≥–∞–º 2000-2024 (–ø—à–µ–Ω–∏—Ü–∞ –æ–∑ –∏ —è—Ä, –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–∏–∫, —Å–æ—è).xls"   # –§–∞–π–ª —Å —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å—é

# --- 2. –§–£–ù–ö–¶–ò–ò –û–ë–†–ê–ë–û–¢–ö–ò –î–ê–ù–ù–´–• ---

def load_and_process_ndvi(filename_data):
    """–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö NDVI —Å 4-–≥–æ –ª–∏—Å—Ç–∞."""
    print("1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö NDVI...")

    # –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å 4-–≥–æ –ª–∏—Å—Ç–∞
    df_ndvi = pd.read_excel(
        filename_data,
        sheet_name="NDVI (MODIS) —è—Ä–æ–≤—ã–µ",
        header=2,  # –ì–æ–¥—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ 3-–π —Å—Ç—Ä–æ–∫–µ (–∏–Ω–¥–µ–∫—Å 2)
        usecols="A:V",  # –°—Ç–æ–ª–±—Ü—ã A-V
        nrows=39  # 39 —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö (—Å 4-–π –ø–æ 42-—é)
    )

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–º–µ—Ä–æ–≤ –Ω–µ–¥–µ–ª—å –∫–∞–∫ –∏–Ω–¥–µ–∫—Å–∞
    week_col = df_ndvi.columns[0]
    # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–æ–º–µ—Ä–∞ –Ω–µ–¥–µ–ª—å –≤ —á–∏—Å–ª–∞
    df_ndvi = df_ndvi.dropna(subset=[week_col])
    df_ndvi[week_col] = pd.to_numeric(df_ndvi[week_col], errors='coerce')
    df_ndvi = df_ndvi.dropna(subset=[week_col])
    df_ndvi = df_ndvi.set_index(week_col)

    # –¢—Ä–∞–Ω—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –ì–æ–¥—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∏–Ω–¥–µ–∫—Å–æ–º, –Ω–µ–¥–µ–ª–∏ - —Å—Ç–æ–ª–±—Ü–∞–º–∏
    df_ndvi = df_ndvi.T
    df_ndvi.index.name = '–ì–æ–¥'

    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –≤ —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞ (–≥–æ–¥—ã)
    df_ndvi.index = pd.to_numeric(df_ndvi.index, errors='coerce').astype(int)

    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ —á–∏—Å–ª–æ–≤–æ–π —Ç–∏–ø
    for col in df_ndvi.columns:
        df_ndvi[col] = pd.to_numeric(df_ndvi[col], errors='coerce')

    # –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ NDVI –∑–∞ —Å–µ–∑–æ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ–¥–∞
    df_ndvi['–°—Ä–µ–¥–Ω–∏–π_NDVI_–°–µ–∑–æ–Ω'] = df_ndvi.mean(axis=1, skipna=True)

    return df_ndvi[['–°—Ä–µ–¥–Ω–∏–π_NDVI_–°–µ–∑–æ–Ω']]


def safe_parse_day(value):
    """–ù–∞–¥–µ–∂–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–Ω—è –∏–∑ —Å—Ç—Ä–æ–∫–∏."""
    if pd.isna(value) or value == '':
        return None

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É –∏ —Ä–∞–∑–±–∏–≤–∞–µ–º –ø–æ –ø—Ä–æ–±–µ–ª—É
    str_value = str(value).strip()
    if not str_value:
        return None

    # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å –¥–æ –ø—Ä–æ–±–µ–ª–∞
    day_str = str_value.split()[0]

    # –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏–ª–∏ –∫–æ–Ω—Ü–µ
    day_str = ''.join(filter(str.isdigit, day_str))

    if not day_str:
        return None

    try:
        return int(day_str)
    except:
        return None


def load_and_process_meteo(filename_data):
    """–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ç–µ–æ–¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞."""
    print("2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ç–µ–æ–¥–∞–Ω–Ω—ã—Ö (–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∏ –û—Å–∞–¥–∫–∏)...")

    meteo_data = {}

    # --- –ó–∞–≥—Ä—É–∑–∫–∞ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (1-–π –ª–∏—Å—Ç) ---
    print("   -> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ (—Ä–æ–≤–Ω–æ —Å B4 –ø–æ V1466)...")

    # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞—á–∏–Ω–∞—è —Å 3-–π —Å—Ç—Ä–æ–∫–∏ (–≥–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≥–æ–¥—ã)
    df_temp = pd.read_excel(
        filename_data,
        sheet_name="–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞",
        header=2,  # –ì–æ–¥—ã –≤ 3-–π —Å—Ç—Ä–æ–∫–µ
        usecols="A:V",  # –°—Ç–æ–ª–±—Ü—ã A-V
        nrows=1463  # –†–æ–≤–Ω–æ 1463 —Å—Ç—Ä–æ–∫–∏ (1466-3)
    )

    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–Ω—è –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
    day_col = df_temp.columns[0]
    df_temp['–î–µ–Ω—å'] = df_temp[day_col].apply(safe_parse_day)

    # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ –¥–Ω–µ–π
    df_temp = df_temp.dropna(subset=['–î–µ–Ω—å'])
    df_temp['–î–µ–Ω—å'] = df_temp['–î–µ–Ω—å'].astype(int)

    # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü —Å –¥–Ω—è–º–∏
    df_temp = df_temp.drop(columns=[day_col])

    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —á–∏—Å–ª–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
    data_cols = df_temp.columns.difference(['–î–µ–Ω—å'])
    for col in data_cols:
        df_temp[col] = pd.to_numeric(df_temp[col], errors='coerce')

    # –ö–û–†–†–ï–ö–¢–ò–†–û–í–ö–ê –¢–ï–ú–ü–ï–†–ê–¢–£–†–´: –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è > 1000, –¥–µ–ª–∏–º –Ω–∞ 1000
    corrected_count = 0
    for col in data_cols:
        mask = (df_temp[col] > 1000) & pd.notna(df_temp[col])
        corrected_values = df_temp.loc[mask, col].count()
        if corrected_values > 0:
            print(f"   -> –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –≤ —Å—Ç–æ–ª–±—Ü–µ {col}: {corrected_values} –∑–Ω–∞—á–µ–Ω–∏–π —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –Ω–∞ 1000")
            corrected_count += corrected_values
            df_temp.loc[mask, col] = df_temp.loc[mask, col] / 1000

    if corrected_count > 0:
        print(f"   -> –í—Å–µ–≥–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã: {corrected_count}")
    else:
        print("   -> –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")

    print(f"   -> –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(df_temp)} –¥–Ω–µ–π –¥–ª—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã")

    # –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ—Å—É—Ç–æ—á–Ω–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
    df_temp_avg = df_temp.groupby('–î–µ–Ω—å')[data_cols].mean()
    df_temp_avg = df_temp_avg.T
    df_temp_avg.index.name = '–ì–æ–¥'
    meteo_data['–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞'] = df_temp_avg

    # --- –ó–∞–≥—Ä—É–∑–∫–∞ –û—Å–∞–¥–∫–æ–≤ (2-–π –ª–∏—Å—Ç) ---
    print("   -> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Å–∞–¥–∫–∞—Ö (—Ä–æ–≤–Ω–æ —Å B4 –ø–æ V1466)...")

    # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞—á–∏–Ω–∞—è —Å 3-–π —Å—Ç—Ä–æ–∫–∏ (–≥–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≥–æ–¥—ã)
    df_precip = pd.read_excel(
        filename_data,
        sheet_name="–û—Å–∞–¥–∫–∏",
        header=2,  # –ì–æ–¥—ã –≤ 3-–π —Å—Ç—Ä–æ–∫–µ
        usecols="A:V",  # –°—Ç–æ–ª–±—Ü—ã A-V
        nrows=1463  # –†–æ–≤–Ω–æ 1463 —Å—Ç—Ä–æ–∫–∏ (1466-3)
    )

    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–Ω—è –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
    day_col = df_precip.columns[0]
    df_precip['–î–µ–Ω—å'] = df_precip[day_col].apply(safe_parse_day)

    # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ –¥–Ω–µ–π
    df_precip = df_precip.dropna(subset=['–î–µ–Ω—å'])
    df_precip['–î–µ–Ω—å'] = df_precip['–î–µ–Ω—å'].astype(int)

    # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü —Å –¥–Ω—è–º–∏
    df_precip = df_precip.drop(columns=[day_col])

    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —á–∏—Å–ª–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
    data_cols = df_precip.columns.difference(['–î–µ–Ω—å'])
    for col in data_cols:
        df_precip[col] = pd.to_numeric(df_precip[col], errors='coerce')

    print(f"   -> –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(df_precip)} –¥–Ω–µ–π –¥–ª—è –æ—Å–∞–¥–∫–æ–≤")

    # –†–∞—Å—á–µ—Ç —Å—É–º–º—ã –æ—Å–∞–¥–∫–æ–≤ –∑–∞ —Å—É—Ç–∫–∏
    df_precip_sum = df_precip.groupby('–î–µ–Ω—å')[data_cols].sum()
    df_precip_sum = df_precip_sum.T
    df_precip_sum.index.name = '–ì–æ–¥'
    meteo_data['–û—Å–∞–¥–∫–∏'] = df_precip_sum

    return meteo_data


def calculate_agro_indicators(meteo_data, temp_threshold=10):
    """
    –†–∞—Å—á–µ—Ç –∞–≥—Ä–æ—ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π, –≤–∫–ª—é—á–∞—è –ì–¢–ö –°–µ–ª—è–Ω–∏–Ω–æ–≤–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–æ–Ω.
    """
    print("3. –†–∞—Å—á–µ—Ç –∞–≥—Ä–æ—ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∏ –ì–¢–ö –°–µ–ª—è–Ω–∏–Ω–æ–≤–∞...")

    df_temp = meteo_data['–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞']
    df_precip = meteo_data['–û—Å–∞–¥–∫–∏']

    results = []

    # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–∏–µ –≥–æ–¥—ã –∏–∑ –æ–±–æ–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö
    common_years = list(set(df_temp.index).intersection(set(df_precip.index)))
    common_years.sort()

    print(f"   -> –û–±—Ä–∞–±–æ—Ç–∫–∞ {len(common_years)} –æ–±—â–∏—Ö –ª–µ—Ç: {common_years}")

    for year in common_years:
        temp_row = df_temp.loc[year]
        precip_row = df_precip.loc[year]

        # –î–Ω–∏ —Å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞ (–ê–∫—Ç–∏–≤–Ω–∞—è –≤–µ–≥–µ—Ç–∞—Ü–∏—è)
        active_days = temp_row > temp_threshold

        # 1. –°—É–º–º–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä (–°–ê–¢)
        sat = temp_row[active_days].sum()

        # 2. –û—Å–∞–¥–∫–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä
        precip_active = precip_row[active_days].sum()

        # 3. –î–ª–∏–Ω–∞ –≤–µ–≥–µ—Ç–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
        dvp = active_days.sum()

        # 4. –ì–¢–ö –°–µ–ª—è–Ω–∏–Ω–æ–≤–∞ = –û—Å–∞–¥–∫–∏ / (–°–ê–¢ * 0.1)
        if sat > 0:
            gtk = precip_active / (sat * 0.1)
        else:
            gtk = np.nan

        # 5. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–æ–Ω—ã –ø–æ –ì–¢–ö
        if pd.isna(gtk):
            zone = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        elif gtk >= 1.6:
            zone = "–ü–µ—Ä–µ—É–≤–ª–∞–∂–Ω–µ–Ω–Ω–∞—è –∑–æ–Ω–∞"
        elif 1.5 <= gtk < 1.6:
            zone = "–í–ª–∞–∂–Ω–∞—è –∑–æ–Ω–∞"
        elif 1.2 <= gtk < 1.5:
            zone = "–£–º–µ—Ä–µ–Ω–Ω–æ –≤–ª–∞–∂–Ω–∞—è –∑–æ–Ω–∞"
        elif 0.4 <= gtk < 1.2:
            zone = "–ó–∞—Å—É—à–ª–∏–≤–∞—è –∑–æ–Ω–∞"
        else:
            zone = "–°—É—Ö–∞—è –∑–æ–Ω–∞" # –º–µ–Ω–µ–µ 0.4

        results.append({
            '–ì–æ–¥': year,
            '–°–ê–¢ (T > 10¬∞C)': sat,
            '–û—Å–∞–¥–∫–∏ –∑–∞ –î–í–ü': precip_active,
            '–î–ª–∏–Ω–∞_–í–µ–≥_–ü–µ—Ä–∏–æ–¥–∞_–¥–Ω–µ–π': dvp,
            '–ì–¢–ö_–°–µ–ª—è–Ω–∏–Ω–æ–≤–∞': gtk,
            '–ó–æ–Ω–∞_–£–≤–ª–∞–∂–Ω–µ–Ω–∏—è': zone
        })

    df_agro = pd.DataFrame(results).set_index('–ì–æ–¥')
    return df_agro


def final_analysis(df_ndvi, df_yield, df_agro):
    """–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏–∑."""
    print("4. –§–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...")

    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    if '–ì–æ–¥' not in df_yield.columns:
        df_yield.columns = ['–ì–æ–¥', '–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å']
    df_yield = df_yield.set_index('–ì–æ–¥')

    # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
    df_final = df_ndvi.join(df_agro, how='inner').join(df_yield, how='inner')

    # --- –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –û–ö–†–£–ì–õ–ï–ù–ò–Ø ---
    # NDVI: –¥–æ 3 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
    df_final['–°—Ä–µ–¥–Ω–∏–π_NDVI_–°–µ–∑–æ–Ω'] = df_final['–°—Ä–µ–¥–Ω–∏–π_NDVI_–°–µ–∑–æ–Ω'].round(3)

    # –°–ê–¢ –∏ –û—Å–∞–¥–∫–∏: –≤ —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞
    df_final['–°–ê–¢ (T > 10¬∞C)'] = df_final['–°–ê–¢ (T > 10¬∞C)'].round(0).astype(int)
    df_final['–û—Å–∞–¥–∫–∏ –∑–∞ –î–í–ü'] = df_final['–û—Å–∞–¥–∫–∏ –∑–∞ –î–í–ü'].round(0).astype(int)

    # –ì–¢–ö –°–µ–ª—è–Ω–∏–Ω–æ–≤–∞: –¥–æ 2 –∑–Ω–∞–∫–æ–≤
    df_final['–ì–¢–ö_–°–µ–ª—è–Ω–∏–Ω–æ–≤–∞'] = df_final['–ì–¢–ö_–°–µ–ª—è–Ω–∏–Ω–æ–≤–∞'].round(2)

    # –£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å: –¥–æ 1 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
    df_final['–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å'] = df_final['–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å'].round(1)

    print("\n--- –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê ---")
    print(f"\nüìä –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: {len(df_final)}")

    correlation = df_final['–°—Ä–µ–¥–Ω–∏–π_NDVI_–°–µ–∑–æ–Ω'].corr(df_final['–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å'])
    print(f"\n‚úÖ –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏ –∏ –°—Ä–µ–¥–Ω–µ–≥–æ NDVI: {correlation:.4f}")

    correlation_gtk = df_final['–ì–¢–ö_–°–µ–ª—è–Ω–∏–Ω–æ–≤–∞'].corr(df_final['–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å'])
    print(f"‚úÖ –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏ –∏ –ì–¢–ö –°–µ–ª—è–Ω–∏–Ω–æ–≤–∞: {correlation_gtk:.4f}")

    print("\n‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ (—Ñ—Ä–∞–≥–º–µ–Ω—Ç):")
    # –í—ã–≤–æ–¥–∏–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    print(df_final[[
        '–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å',
        '–°—Ä–µ–¥–Ω–∏–π_NDVI_–°–µ–∑–æ–Ω',
        '–ì–¢–ö_–°–µ–ª—è–Ω–∏–Ω–æ–≤–∞',
        '–ó–æ–Ω–∞_–£–≤–ª–∞–∂–Ω–µ–Ω–∏—è'
    ]].sort_index())

    return df_final


# --- 3. –ó–ê–ì–†–£–ó–ö–ê –£–†–û–ñ–ê–ô–ù–û–°–¢–ò –° –ù–û–í–û–ô –°–¢–†–£–ö–¢–£–†–û–ô ---
def load_yield_data(filename_yield):
    """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏ –∏–∑ Excel: —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∞ EQ81:FK81 (—É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å) –∏ EQ5:FK5 (–≥–æ–¥—ã)."""
    print("0. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏...")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–≤–∏–∂–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    file_ext = os.path.splitext(filename_yield)[1].lower()
    engine = 'xlrd' if file_ext == '.xls' else 'openpyxl'

    print(f"   -> –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–≤–∏–∂–æ–∫: {engine} –¥–ª—è —Ñ–∞–π–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∞ {file_ext}")

    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏: 5-—é (–≥–æ–¥—ã) –∏ 81-—é (—É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å)
        df = pd.read_excel(
            filename_yield,
            header=None,
            engine=engine,
            nrows=81,  # –ß–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 81 —Å—Ç—Ä–æ–∫–∏
            usecols="EQ:FK"  # –ß–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–æ–ª–±—Ü—ã —Å EQ –ø–æ FK (125-145)
        )

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –Ω—É–∂–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        if len(df) < 81:
            print(f"   -> –û—à–∏–±–∫–∞: –≤ —Ñ–∞–π–ª–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç—Ä–æ–∫. –ù–∞–π–¥–µ–Ω–æ —Ç–æ–ª—å–∫–æ {len(df)} —Å—Ç—Ä–æ–∫.")
            return pd.DataFrame(columns=['–ì–æ–¥', '–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å'])

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –≥–æ–¥—ã –∏–∑ 5-–π —Å—Ç—Ä–æ–∫–∏ (–∏–Ω–¥–µ–∫—Å 4)
        years_row = df.iloc[4].values

        # –ò–∑–≤–ª–µ–∫–∞–µ–º —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å –∏–∑ 81-–π —Å—Ç—Ä–æ–∫–∏ (–∏–Ω–¥–µ–∫—Å 80)
        yield_row = df.iloc[80].values

        # –û—á–∏—Å—Ç–∫–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        years_clean = []
        yields_clean = []

        for year_val, yield_val in zip(years_row, yield_row):
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–¥–∞
            if pd.notna(year_val) and str(year_val).strip() != '':
                try:
                    year_num = float(str(year_val).strip())
                    years_clean.append(int(year_num))
                except:
                    continue

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏
            if pd.notna(yield_val) and str(yield_val).strip() != '':
                try:
                    yield_num = float(str(yield_val).strip())
                    yields_clean.append(yield_num)
                except:
                    yields_clean.append(np.nan)

        # –°–æ–∑–¥–∞–µ–º DataFrame —Ç–æ–ª—å–∫–æ —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        df_yield = pd.DataFrame({
            '–ì–æ–¥': years_clean,
            '–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å': yields_clean
        })

        # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        df_yield = df_yield.dropna(subset=['–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å'])

        print(f"   -> –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏ –¥–ª—è {len(df_yield)} –ª–µ—Ç: {df_yield['–ì–æ–¥'].values}")
        return df_yield

    except Exception as e:
        print(f"   -> –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏: {str(e)}")
        return pd.DataFrame(columns=['–ì–æ–¥', '–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å'])


# --- 4. –û–°–ù–û–í–ù–û–ô –ü–†–û–¶–ï–°–° ---
def run_agriclimate_analysis():
    # –®–∞–≥ 0: –ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏
    df_yield = load_yield_data(FILE_YIELD)

    if df_yield.empty:
        print("‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–± —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏. –ê–Ω–∞–ª–∏–∑ –ø—Ä–µ—Ä–≤–∞–Ω.")
        return

    # –®–∞–≥ 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ NDVI (–±–µ–∑ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏)
    df_ndvi = load_and_process_ndvi(FILE_DATA)

    # –®–∞–≥ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ç–µ–æ–¥–∞–Ω–Ω—ã—Ö
    meteo_data = load_and_process_meteo(FILE_DATA)

    # –®–∞–≥ 3: –†–∞—Å—á–µ—Ç –∞–≥—Ä–æ—ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π (–í–∫–ª—é—á–∞—è –ì–¢–ö)
    df_agro = calculate_agro_indicators(meteo_data)

    # –®–∞–≥ 4: –§–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    df_final = final_analysis(df_ndvi, df_yield, df_agro)

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    output_file = "Final_Agroclimate_Analysis_GTK_NoClass.xlsx"
    df_final.to_excel(output_file)
    print(f"\nüíæ –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ '{output_file}'")

# --- –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ ---
if __name__ == "__main__":
    run_agriclimate_analysis()